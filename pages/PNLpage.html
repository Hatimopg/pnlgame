<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PNL Dilemme ‚Äî Ta musique pr√©f√©r√©e</title>

  <!-- CSS dans /styles -->
  <link rel="stylesheet" href="../styles/PNLstyle.css" />
</head>

<body>
  <div class="bg-orb orb-a"></div>
  <div class="bg-orb orb-b"></div>
  <div class="bg-orb orb-c"></div>

  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">
        <span class="logoDot"></span>
        <span class="logoDot"></span>
        <span class="logoDot"></span>
      </div>
      <div class="brandText">
        <div class="brandTitle">PNL Dilemme</div>
        <div class="brandSub">Choisis entre 2 sons ‚Äî on trouve ton pr√©f√©r√©</div>
      </div>
    </div>

    <div class="hud">
      <div class="hudItem">
        <div class="hudLabel">Avancement</div>
        <div class="progressWrap">
          <div class="progressBar" id="progressBar"></div>
          <div class="progressGlow"></div>
        </div>
      </div>

      <div class="hudItem hudRight">
        <div class="hudLabel">Duel</div>
        <div class="hudValue"><span id="duelIndex">1</span> / <span id="duelTotal">?</span></div>
      </div>

      <button class="btnGhost" id="btnRestart" type="button" title="Recommencer">
        <span class="btnIcon">‚Üª</span> Rejouer
      </button>
    </div>
  </header>

  <main class="stage" id="stage">
    <section class="arena" id="arena">
      <div class="hint" id="hint">
        <span class="hintPulse"></span>
        Clique sur la carte de ton choix
      </div>

      <div class="cards" id="cards">
        <!-- Cartes inject√©es en JS -->
      </div>

      <div class="microHud">
        <div class="chip" id="chipRound">Round 1</div>
        <div class="chip chipSoft" id="chipRemaining">Chargement‚Ä¶</div>
      </div>
    </section>

    <section class="result hidden" id="result">
      <div class="resultCard">
        <div class="resultSpark"></div>
        <div class="resultTitle">Voici votre musique PNL pr√©f√©r√©e</div>
        <div class="resultTrack" id="resultTrack">‚Äî</div>

        <div class="resultCoverWrap">
          <img id="resultCover" class="resultCover" alt="Cover" />
          <div class="resultRing"></div>
        </div>

        <div class="resultActions">
          <button class="btnPrimary" id="btnPlayAgain" type="button">Rejouer</button>
          <button class="btnGhost" id="btnShare" type="button">Copier le r√©sultat</button>
        </div>

        <div class="toast" id="toast">Copi√© ‚úÖ</div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footerLeft">Covers: /covers ¬∑ CSS: /styles</div>
    <div class="footerRight">Animations + tournoi al√©atoire</div>
  </footer>
  
  <script>
  // =========================
  // 1) DATA ‚Äî titres + covers
  // =========================
  const COVER = {
    qlf: "../covers/qlf.jpg",
    lmc: "../covers/lmc.jpeg",
    ddl: "../covers/ddl.jpeg",
    df: "../covers/deuxfreres.jpeg",
  };

  const ALBUM_THEMES = {
    "Que La Famille": { a: "#ff4fd8", b: "#ffffff" },
    "Le Monde Chico": { a: "#050505", b: "#4a0013" },
    "Dans La L√©gende": { a: "#ff7a18", b: "#ffb199" },
    "Deux Fr√®res": { a: "#2b6cff", b: "#ff4fd8" },
  };

  const album1 = [
    "Je vis, Je visser","Lala","Diff√©rents","Oblig√©s de prendre","De la fen√™tre au ter-ter","PNL",
    "J'comprends pas","Gala Gala","La petite voix","Ath√©na","Recherche du bonheur","Simba",
  ].map(t => ({ title: t, album: "Que La Famille", cover: COVER.qlf }));

  const album2 = [
    "Le monde ou rien","Sur Paname","Oh lala","J'vends","Abonn√©","J'suis PNL","Mexico","Porte de Mesrine",
    "Dans ta rue","Laisse","Loin des hommes","Le M","Rebenga","Plus Tony que Sosa","Que la mif",
    "Temp√™te","Dans la sououpe",
  ].map(t => ({ title: t, album: "Le Monde Chico", cover: COVER.lmc }));

  const album3 = [
    "Da","Naha","Dans la l√©gende","Mira","J'suis QLF","La vie est belle","Kratos","Luz de Luna",
    "Tu sais pas","Sheita","Humain","Bambina","Ben√©","Uranus","Onizuka","Jusq'au dernier gramme",
    "Cram√©s","Je t'haine",
  ].map(t => ({ title: t, album: "Dans La L√©gende", cover: COVER.ddl }));

  const album4 = [
    "Au DD","Autre monde","Chang","Blanka","91's","A l'ammoniaque","Celsius","Deux fr√®res","Hasta la vista",
    "C≈ìurs","Shenmue","Kuta Ubud","Menace","Zoulou Tchaing","D√©connect√©","La mis√®re est si belle",
    "Ryuk","Comme pas deux","Sib√©rie","Bang","Capuche","Fronti√®res",
  ].map(t => ({ title: t, album: "Deux Fr√®res", cover: COVER.df }));

  const ALL_TRACKS = [...album1, ...album2, ...album3, ...album4]
    .map((x, i) => ({ id: i + 1, ...x }));

  // =========================
  // 2) Helpers
  // =========================
  const $ = (sel) => document.querySelector(sel);
  const cardsEl = $("#cards");
  const resultEl = $("#result");
  const stageEl = $("#stage");
  const arenaEl = $("#arena");
  const toastEl = $("#toast");
  const progressBar = $("#progressBar");
  const duelIndexEl = $("#duelIndex");
  const duelTotalEl = $("#duelTotal");
  const chipRound = $("#chipRound");
  const chipRemaining = $("#chipRemaining");

  function shuffle(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function clamp(n, min, max) {
    return Math.max(min, Math.min(max, n));
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function mixHex(c1, c2, t = 0.5) {
    const a = hexToRgb(c1), b = hexToRgb(c2);
    return rgbToHex(
      Math.round(a.r + (b.r - a.r) * t),
      Math.round(a.g + (b.g - a.g) * t),
      Math.round(a.b + (b.b - a.b) * t)
    );
  }

  function hexToRgb(hex) {
    const n = parseInt(hex.replace("#", ""), 16);
    return { r: (n >> 16) & 255, g: (n >> 8) & 255, b: n & 255 };
  }

  function rgbToHex(r, g, b) {
    return "#" + [r, g, b].map(v => v.toString(16).padStart(2, "0")).join("");
  }

  function themeForAlbum(album) {
    return ALBUM_THEMES[album];
  }

  function applyDuelTheme(left, right) {
    const L = themeForAlbum(left.album);
    const R = themeForAlbum(right.album);

    arenaEl.style.setProperty("--bg-left", mixHex(L.a, L.b, 0.5));
    arenaEl.style.setProperty("--bg-right", mixHex(R.a, R.b, 0.5));
    arenaEl.style.setProperty("--bg-mid", mixHex(L.a, R.b, 0.5));
  }

  // =========================
  // 3) GAME STATE (CHAMPION)
  // =========================
  let currentChampion = null;
  let currentPool = [];
  let duelIndex = 0;
  let duelTotal = 0;
  let locked = false;

  function resetGame() {
    locked = false;

    resultEl.classList.add("hidden");
    stageEl.classList.remove("done");

    const shuffled = shuffle(ALL_TRACKS);
    currentChampion = shuffled.shift(); // üëë premier son
    currentPool = shuffled;

    duelIndex = 0;
    duelTotal = ALL_TRACKS.length - 1;
    duelTotalEl.textContent = duelTotal;

    updateHud();
    renderNext();
  }

  function updateHud() {
    duelIndexEl.textContent = Math.max(1, duelIndex);
    chipRound.textContent = "Dilemme";
    chipRemaining.textContent = `${currentPool.length} titres restants`;

    const pct = clamp((duelIndex / duelTotal) * 100, 0, 100);
    progressBar.style.width = pct + "%";
  }

  function renderNext() {
    if (currentPool.length === 0) {
      return finish(currentChampion);
    }

    const challenger = currentPool.shift();
    duelIndex++;
    updateHud();

    cardsEl.innerHTML = "";
    applyDuelTheme(currentChampion, challenger);

    cardsEl.appendChild(createCard(currentChampion));
    cardsEl.appendChild(createCard(challenger));
  }

  function createCard(track) {
    const theme = themeForAlbum(track.album);
    const isDark = track.album === "Le Monde Chico";

    const card = document.createElement("button");
    card.className = "card in";
    card.style.setProperty("--accent", mixHex(theme.a, theme.b, 0.5));

    card.innerHTML = `
      <div class="cardFx">
        <div class="cardSheen"></div>
        <div class="cardBorder"></div>
        <div class="cardNoise"></div>
      </div>

      <div class="coverWrap">
        <img class="cover" src="${track.cover}">
        <div class="coverGlow"></div>
        <div class="coverScan"></div>
      </div>

      <div class="meta" style="color:${isDark ? "#ffffff" : "inherit"}">
        <div class="title">${escapeHtml(track.title)}</div>
        <div class="sub">${escapeHtml(track.album)}</div>
      </div>

      <div class="pickHint">
        <span class="pickDot"></span> Choisir
      </div>
    `;

    card.onclick = () => onPick(track);
    return card;
  }

  function onPick(track) {
    if (locked) return;
    locked = true;

    const isChampion = track.id === currentChampion.id;
    currentChampion = isChampion ? currentChampion : track;

    setTimeout(() => {
      locked = false;
      renderNext();
    }, 450);
  }

  function finish(winner) {
    stageEl.classList.add("done");
    resultEl.classList.remove("hidden");
    $("#resultTrack").textContent = winner.title;
    $("#resultCover").src = winner.cover;
    progressBar.style.width = "100%";
    chipRemaining.textContent = "Termin√© ‚úÖ";
  }

  // =========================
  // 4) Buttons
  // =========================
  $("#btnRestart").onclick = resetGame;
  $("#btnPlayAgain").onclick = resetGame;

  $("#btnShare").onclick = async () => {
    const text = `Ma musique PNL pr√©f√©r√©e : ${$("#resultTrack").textContent}`;
    try {
      await navigator.clipboard.writeText(text);
      toastEl.classList.add("show");
      setTimeout(() => toastEl.classList.remove("show"), 1000);
    } catch {}
  };

  // =========================
  // 5) Start
  // =========================
  resetGame();
</script>

</body>
</html>